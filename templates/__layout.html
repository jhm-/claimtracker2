<!DOCTYPE html>
<html>
<head>
    <title>claimtracker2</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100..900;1,100..900&display=swap');
        html, body {
            height: 100%;
            margin: 0;
        }

        .container {
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow: hidden;
        }

        .content {
            display: flex;
            flex: 1;
        }

        .main {
            flex: 1;
        }

        #header {
            background-color: hsl(203deg 100% 32%);
            color: white;
            padding: 0px;
            margin: 0px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        #table_select {
            background-color: hsl(203deg 100% 32%);
            color: white;
            border: none;
            margin: auto;
            padding: 15px;
            font-family: "Roboto", sans-serif;
            font-size: 18px;

        }

        th {
            cursor: pointer;
            position: relative;
            padding-right: 20px;
        }

        th::after {
            content: "";
            position: absolute;
            right: 5px;
            top: 50%;
            transform: translateY(-50%);
            border-left: 5px solid transparent;
            border-right: 5px solid transparent;
            border-bottom: 5px solid black;
        }

        th.sorted-asc::after {
            border-top: 5px solid black;
            border-bottom: 5px solid transparent;
        }

        .header-links {
            display: flex;
            align-items: center;
            margin-right: 10px;
            font-family: "Roboto", sanf-serif;
            font-size: 18px;
        }

        .header-links a {
            color: white;
            text-decoration: none;
            margin-left: 10px;
            margin-right: 10px;
            padding: 10px;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 10% auto;
            padding: 20px;
            line-height: 1.5;
            border: 1px solid #888;
            width: 50%;
            font-family: "Roboto", sans-serif;
            font-size: 20px;
        }

        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }

        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }

        .modal-body input[type=text],
        .modal-body select {
            width: 100%;
            padding: 12px 20px;
            margin-bottom: 10px;
            font-size: 18px;
            display: inline-block;
            border: 1px solid #ccc;
            box-sizing: border-box;
        }
        
        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 10px;
            align-items: center;
        }

        .form-field {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        .modal-body label {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 5px;
        }


        .modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }

        .modal-buttons button {
            background-color: hsl(203deg 100% 32%);
            color: white;
            padding: 10px 18px;
            border: none;
            cursor: pointer;
            font-size: 16px;
        }

        .modal-buttons button:hover {
            opacity: 0.8;
        }

        .cancel-button {
            background-color: #888;
        }
        
        .modal-buttons button.submit-button {
            background-color: hsl(203deg 100% 32%);
        }

        #loading-indicator {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            padding: 20px;
            border-radius: 5px;
            z-index: 2;
            font-family: "Roboto", sans-serif;
            font-size: 20px;
        }
    </style>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // table sorting 
        function sortTable(n) {
            let table, rows, switching, i, x, y, shouldSwitch, dir, switchcount = 0;
            table = document.getElementsByTagName("table")[0];
            switching = true;
            let headers = table.rows[0].getElementsByTagName("TH");
            let currentHeader = headers[n];
            // check if currently sorted and reverse direction
            if (currentHeader.classList.contains("sorted-asc")) {
                dir = "desc";
            } else if (currentHeader.classList.contains("sorted-desc")) {
                dir = "asc";
            } else {
                dir = "asc"; // default to ascending
            }

            while (switching) {
                switching = false;
                rows = table.rows;
                for (i = 1; i < (rows.length - 1); i++) {
                    shouldSwitch = false;
                    x = rows[i].getElementsByTagName("TD")[n];
                    y = rows[i + 1].getElementsByTagName("TD")[n];

                    let xContent = x.innerHTML.toLowerCase();
                    let yContent = y.innerHTML.toLowerCase();

                    if (dir == "asc") {
                        if (xContent > yContent) {
                            shouldSwitch = true;
                            break;
                        }
                    } else if (dir == "desc") {
                        if (xContent < yContent) {
                            shouldSwitch = true;
                            break;
                        }
                    }
                }
                if (shouldSwitch) {
                    rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
                    switching = true;
                    switchcount++;
                } else {
                    // this block ensures a full cycle (asc then desc) if not yet sorted
                    if (switchcount == 0 && dir == "asc") {
                        dir = "desc";
                        switching = true;
                    }
                }
            }
            
            // update class for header styling
            for (let j = 0; j < headers.length; j++) {
                headers[j].classList.remove("sorted-asc", "sorted-desc");
            }

            if (dir == "asc") {
                currentHeader.classList.add("sorted-asc");
            } else {
                currentHeader.classList.add("sorted-desc");
            }
        }
        
        // add event listeners to table headers for sorting
        let tableHeaders = document.querySelectorAll('th');
        tableHeaders.forEach((header, index) => {
            header.addEventListener('click', () => sortTable(index));
        });
        

        var newTableModal = document.getElementById("newTableModal");
        var deleteTableModal = document.getElementById("deleteTableModal");
        var renameTableModal = document.getElementById("renameTableModal");
        var propertiesModal = document.getElementById("propertiesModal");
        var renameTableForm = document.getElementById("renameTableForm");
        var propertiesForm = document.getElementById("propertiesForm");
        var renameCloseButton = document.getElementById("renameCloseButton");
        var propertiesCloseButton = document.getElementById("propertiesCloseButton");
        var renameCancelButton = document.getElementById("renameCancelButton");
        var propertiesCancelButton = document.getElementById("propertiesCancelButton");
        var newTableNameInput = document.getElementById("new_table_name");

        var newLink = document.querySelector('.header-links a[href="/new"]');
        var deleteLink = document.querySelector('.header-links a[href="/delete"]');
        var renameLink = document.querySelector('.header-links a[href="/rename"]');
        var propertiesLink = document.querySelector('.header-links a[href="/properties"]');

        var closeButton = newTableModal.querySelector(".close-button");
        var deleteConfirmButton = deleteTableModal.querySelector('button[type="submit"]');
        var deleteCancelButton = deleteTableModal.querySelector('button.cancel-button');
        var deleteCloseButton = deleteTableModal.querySelector('.close-button');
        var newTableForm = document.getElementById("newTableForm");
        var tableSelect = document.getElementById("table_select");
        var loadingIndicator = document.getElementById("loading-indicator");
        
        var currentTableName = tableSelect.value;
        
        function showLoading() { loadingIndicator.style.display = "block"; }
        function hideLoading() { loadingIndicator.style.display = "none"; }

        function showDeleteModal() { deleteTableModal.style.display = "block"; }
        function hideDeleteModal() { deleteTableModal.style.display = "none"; }

        function showRenameModal(currentName) {
            renameTableModal.querySelector('b').textContent = "Rename Table: " + currentName;
            newTableNameInput.value = currentName;
            renameTableModal.style.display = "block";
            newTableNameInput.focus(); 
            newTableNameInput.select(); 
        }
        function hideRenameModal() { renameTableModal.style.display = "none"; }
        
        function showPropertiesModal(currentName) {
            propertiesModal.querySelector('b').textContent = "Properties for Table: " + currentName;
            propertiesModal.style.display = "block";
        }
        function hidePropertiesModal() { propertiesModal.style.display = "none"; }

        // function to validate the table name
        function validateString(name) {
            const regex = /^[a-zA-Z0-9_]+$/;
            return regex.test(name);
        }

        if (newLink) {
            newLink.addEventListener('click', function(event) {
                event.preventDefault();
                newTableModal.style.display = "block";
            });
        }
        if (closeButton) {
            closeButton.addEventListener('click', function() {
                newTableModal.style.display = "none";
            });
        }
        
        if (propertiesLink) {
            propertiesLink.addEventListener('click', function(event) {
                event.preventDefault();
                var currentSelectedTable = tableSelect.value;
                showPropertiesModal(currentSelectedTable);
            });
        }
        if (propertiesCloseButton) {
            propertiesCloseButton.addEventListener('click', hidePropertiesModal);
        }
        if (propertiesCancelButton) {
            propertiesCancelButton.addEventListener('click', hidePropertiesModal);
        }
        
        if (propertiesForm) {
            propertiesForm.addEventListener('submit', function(event) {
                event.preventDefault();
                var form = event.target;
                var formData = new FormData(form);
                var data = {};
                formData.forEach((value, key) => {
                    if (form.elements[key] && form.elements[key].type === 'checkbox') {
                         data[key] = form.elements[key].checked ? 'true' : 'false';
                    } else {
                        data[key] = value;
                    }
                });
                
                data['table_name'] = tableSelect.value; 

                showLoading();
                fetch('/properties', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}' 
                    },
                    body: JSON.stringify(data)
                })
                .then(response => response.json())
                .then(data => {
                    hideLoading();
                    if (data.success) {
                        alert('Table properties updated successfully!');
                        hidePropertiesModal();
                    } else {
                        alert('Error updating properties: ' + data.error);
                    }
                })
                .catch(error => {
                    hideLoading();
                    console.error('Error updating properties:', error);
                    alert('An unexpected error occurred during properties update.');
                });
            });
        }
        
        if (renameLink) {
            renameLink.addEventListener('click', function(event) {
                event.preventDefault();
                var currentSelectedTable = tableSelect.value;
                showRenameModal(currentSelectedTable);
            });
        }
        if (renameCloseButton) {
            renameCloseButton.addEventListener('click', hideRenameModal);
        }
        if (renameCancelButton) {
            renameCancelButton.addEventListener('click', hideRenameModal);
        }

        if (renameTableForm) {
            renameTableForm.addEventListener('submit', function(event) {
                event.preventDefault();
                var oldTableName = tableSelect.value;
                var newName = newTableNameInput.value;

                if (!validateString(newName)) {
                    alert("Table names must contain only letters, numbers and underscores, with no spaces or special characters.");
                    return;
                }
                
                if (newName === oldTableName) {
                    alert("The new name must be different from the current name.");
                    return;
                }

                showLoading();
                fetch('/rename', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}' 
                    },
                    body: JSON.stringify({ 
                        table_name: oldTableName, 
                        new_name: newName 
                    })
                })
                .then(response => response.json())
                .then(data => {
                    hideLoading();
                    if (data.success) {
                        // update the option element's value and text in the dropdown
                        var optionToRename = tableSelect.querySelector('option[value="' + oldTableName + '"]');
                        if (optionToRename) {
                            optionToRename.value = newName;
                            optionToRename.text = newName;
                            // set the dropdown to the newly renamed table
                            tableSelect.value = newName; 
                        }
                        
                        if (data.redirect_url) {
                            window.location.href = data.redirect_url;
                        } else {
                            window.location.reload(); 
                        }
                        hideRenameModal();
                    } else {
                        alert('Error renaming table: ' + data.error);
                    }
                })
                .catch(error => {
                    hideLoading();
                    console.error('Error renaming table:', error);
                    alert('An unexpected error occurred during renaming.');
                });
            });
        }
        
        window.addEventListener('click', function(event) {
            if (event.target == deleteTableModal) {
                hideDeleteModal();
            }
            if (event.target == newTableModal) {
                newTableModal.style.display = "none";
            }
            if (event.target == renameTableModal) {
                hideRenameModal();
            }
            if (event.target == propertiesModal) {
                hidePropertiesModal();
            }
        });

        if (deleteLink) {
            deleteLink.addEventListener('click', function(event) {
                event.preventDefault();
                showDeleteModal();
            });
        }
        if (deleteCloseButton) {
            deleteCloseButton.addEventListener('click', hideDeleteModal);
        }
        if (deleteCancelButton) {
            deleteCancelButton.addEventListener('click', hideDeleteModal);
        }

        if (deleteConfirmButton) {
            deleteConfirmButton.addEventListener('click', function(event) {
                event.preventDefault();
        
                showLoading();

                var selectedTable = document.getElementById("table_select").value;

                fetch('/delete', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({ table_name: selectedTable })
                })
                .then(response => response.json())
                .then(data => {
                    hideLoading();
                    if (data.success) {
                        var optionToRemove = tableSelect.querySelector('option[value="' + selectedTable + '"]'); // Fix template literal issue
                        if (optionToRemove) {
                            console.error("Got it")
                            optionToRemove.remove();
                        }
                        if (tableSelect.options.length > 0) {
                            tableSelect.value = tableSelect.options[0].value;
                        }
                        window.location.href = '/';
                    } else {
                        alert('Error deleting table: ' + data.error);
                        hideDeleteModal();
                    }
                })
                .catch(error => {
                    hideLoading();
                    console.error('Error:', error);
                    alert('An unexpected error occurred.');
                    hideDeleteModal();
                });
            });
        }
        
        if (newTableForm) {
            newTableForm.addEventListener('submit', function(event) {
                event.preventDefault();
                var tableNameInput = document.getElementById("table_name");
                var tableName = tableNameInput.value;

                if (!validateString(tableName)) {
                    alert("Table names must contain only letters, numbers and underscores, with no spaces or " +
                    "special characters.");
                    return;
                }

                if (tableName) {
                    showLoading();
                    fetch('/new', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token }}'
                        },
                        body: JSON.stringify({ table_name: tableName })
                    })
                    .then(response => response.json())
                    .then(data => {
                        hideLoading();
                        if (data.success) {
                            var newOption = document.createElement("option");
                            newOption.value = tableName;
                            newOption.text = tableName;
                            tableSelect.appendChild(newOption);
                            tableSelect.value = tableName;
                            window.location.href = '/' + tableName;
                            newTableModal.style.display = "none";
                        } else {
                            alert('Error creating table: ' + data.error);
                        }
                    })
                    .catch(error => {
                        hideLoading();
                        console.error('Error creating table:', error);
                        alert('An unexpected error occurred.');
                    });
                } else {
                    alert("Please enter a table name.");
                }
            });
        }
    });
    </script>
    </head>
<body>
    <div class="container">
        <div id="header">
            <form method="POST" style="margin-right: auto;">
                <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                <img src="/static/icon.png" style="height: 32px; width: auto; margin-top: 10px; margin-bottom: -10px; margin-left: 10px"/>
                <select name="table_select" id="table_select" onchange="this.form.submit()">
                    {% for table in tables %}
                        <option value="{{ table }}" {% if selected_table == table %}selected{% endif %}>{{ table }}</option>
                    {% endfor %}
                </select>
            </form>
            <div class="header-links">
                <a href = "/update">Update</a> | <a href="/properties">Properties</a> | <a href="/new">New</a> | <a href="/rename">Rename</a> | <a href="/delete">Delete</a>
            </div>
        </div>
    <div id="content" class="content">
        {% if selected_url %}
            <iframe src="{{ selected_url }}" style="width: 100%; height: 100%; overflow: auto;"></iframe>
        {% endif %}
    </div>
    
    <div id="propertiesModal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="propertiesCloseButton">&times;</span>
            <b>Properties for Table: {{ selected_table }}</b>
            <div class="modal-body">
                <form id="propertiesForm" action="/properties" method="POST">
                    <input type="hidden" name="table_name" value="{{ selected_table }}">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                    <div class="form-field">
                        <label for="ColumnOrder">Column Order (Semicolon separated):</label>
                        <input type="text" name="ColumnOrder" id="ColumnOrder" 
                               value="{{ property_values.ColumnOrder or '' }}" required>
                    </div>
                    <div class="form-field">
                        <label for="CompactColumnOrder">Compact Column Order (Semicolon separated):</label>
                        <input type="text" name="CompactColumnOrder" id="CompactColumnOrder" 
                               value="{{ property_values.CompactColumnOrder or '' }}">
                    </div>
                    <div class="form-field">
                        <label for="AccessList">Access List (Semicolon separated emails):</label>
                        <input type="text" name="AccessList" id="AccessList" 
                               value="{{ property_values.AccessList or '' }}" required>
                    </div>
                    <div class="form-row">
                        <div class="form-field">
                            <label for="UpdateSched">Update Schedule (Cron format):</label>
                            <input type="text" name="UpdateSched" id="UpdateSched" 
                                   value="{{ property_values.UpdateSched or '' }}" required>
                        </div>
                        <div class="form-field">
                            <label for="EmailSched">Email Schedule (Cron format):</label>
                            <input type="text" name="EmailSched" id="EmailSched" 
                                   value="{{ property_values.EmailSched or '' }}" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-field">
                            <label for="Prune">Prune:</label>
                            <select name="Prune" id="Prune" required>
                                <option value="true" {% if property_values.Prune == 'true' %}selected{% endif %}>True</option>
                                <option value="false" {% if property_values.Prune == 'false' %}selected{% endif %}>False</option>
                            </select>
                        </div>
                        <div class="form-field">
                            <label for="Compact">Compact:</label>
                            <select name="Compact" id="Compact" required>
                                <option value="true" {% if property_values.Compact == 'true' %}selected{% endif %}>True</option>
                                <option value="false" {% if property_values.Compact == 'false' %}selected{% endif %}>False</option>
                            </select>
                        </div>
                    </div>
                    <div class="modal-buttons">
                        <button type="submit" class="submit-button">Save Changes</button>
                        <button type="button" class="cancel-button" id="propertiesCancelButton">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <div id="newTableModal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <b>Create New Table</b>
            <div class="modal-body">
                <form id="newTableForm">
                        <label for="table_name"><i>Table Name:</i></label>
                    <input type="text" placeholder="Enter table name" name="table_name" id="table_name" required>
                    <div class="modal-buttons">
                        <button type="submit">Create</button>
                        <button type="button" class="cancel-button" onclick="document.getElementById('newTableModal').style.display='none'">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="renameTableModal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="renameCloseButton">&times;</span>
            <b>Rename Table: {{ selected_table }}</b>
            <div class="modal-body">
                <form id="renameTableForm">
                    <label for="new_table_name"><i>New Table Name:</i></label>
                    <input type="text" placeholder="Enter new table name" name="new_table_name" id="new_table_name" value="{{ selected_table }}" required>
                    <div class="modal-buttons">
                        <button type="submit">Rename</button>
                        <button type="button" class="cancel-button" id="renameCancelButton">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <div id="deleteTableModal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <b>Delete Table</b>
            <div class="modal-body">
                    Are you sure you want to delete &lt;{{ selected_table }}&gt;? <i>This cannot be undone!</i>
                    <div class="modal-buttons">
                            <button type="submit">Delete</button>
                            <button type="button" class="cancel-button">Cancel</button>
                    </div>
            </div>
        </div>
    </div>

    <div id="loading-indicator">Please wait...</div>
</body>
</html>
